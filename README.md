# Supabase Logger

A simple and flexible Node.js library for logging traces to a Supabase database.

## Installation

```bash
npm install
```

(Note: This library is not on npm yet, you would install its dependencies locally).

## Features

- **Simple API**: A single `log` method for all your logging needs.
- **Flexible Context**: Add rich context like `companyId`, `service`, `namespace`, and `correlationId` to your logs.
- **Defaults**: Set default values for context at initialization and override them anytime.
- **Automatic Timestamps**: Leverages the database for accurate and reliable `created_at` timestamps.

## Usage

### 1. Initialization

First, initialize the library with your Supabase URL and key. You can also provide default values for `companyId`, `service`, and `namespace` that will be used in all logs unless overridden.

```javascript
const logger = require('./index.js'); // Use require('supabase-logger') if published

const supabaseUrl = 'YOUR_SUPABASE_URL';
const supabaseKey = 'YOUR_SUPABASE_KEY';

// Set up default context for your application
const options = {
  companyId: 'your-default-company-id',
  service: 'main-app',
  namespace: 'general'
};

logger.initialize(supabaseUrl, supabaseKey, options);
```

### 2. Logging

Use the `log` method to send traces. It takes a single object with all the necessary information. The method returns the `correlationId` used for the log entry, which can be useful for linking subsequent logs.

```javascript
const { log, LogLevel } = require('./index.js');

async function userLogin(email) {
  // Log the start of a method, creating a new correlationId
  const correlationId = await log({
    level: LogLevel.INFO,
    message: `Attempting login for ${email}`,
    service: 'Authentication',
    namespace: 'project-andromeda.Login'
  });

  try {
    // ... your login logic here ...

    // Log a success event, reusing the same correlationId
    await log({
      level: LogLevel.LOG,
      message: 'User successfully authenticated',
      data: { userId: 'user-123' },
      service: 'Authentication',
      namespace: 'project-andromeda.Login',
      correlationId: correlationId // Link this log to the previous one
    });

  } catch (error) {
    // Log an error, also reusing the correlationId
    await log({
      level: LogLevel.ERROR,
      message: 'Login failed',
      data: { errorMessage: error.message },
      service: 'Authentication',
      namespace: 'project-andromeda.Login',
      correlationId: correlationId
    });
  }
}
```

#### LogLevel

Use `LogLevel` to specify the severity of the trace:

- `LogLevel.ERROR` (0)
- `LogLevel.LOG` (1)
- `LogLevel.INFO` (2)
- `LogLevel.DEBUG` (3)

## Supabase Setup

You need to create a table named `auditoria` in your Supabase database. Use the following SQL command to create it:

```sql
CREATE TABLE auditoria (
  id bigint generated by default as identity primary key,
  created_at timestamptz default now(),
  level smallint,
  message text,
  data jsonb,
  company_id text,
  service text,
  namespace text,
  correlation_id uuid
);
```
